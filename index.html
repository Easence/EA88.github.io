<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="见自己、见天地、见众生">
<meta property="og:type" content="website">
<meta property="og:title" content="EA88'Blog">
<meta property="og:url" content="https://github.com/Easence/index.html">
<meta property="og:site_name" content="EA88'Blog">
<meta property="og:description" content="见自己、见天地、见众生">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="EA88'Blog">
<meta name="twitter:description" content="见自己、见天地、见众生">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/Easence/"/>





  <title> EA88'Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/avatar.jpg"
             alt="EA88'Blog"/>
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">EA88'Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">见自己、见天地、见众生</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/11/15/苹果的文字系统/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/15/苹果的文字系统/" itemprop="url">
                  苹果文字系统
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-15T10:33:17+08:00">
                2016-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS开发笔记/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          对苹果关于文字处理部分的官方文档进行了总结，基本上涵盖了iOS开发中关于Text的所需了解的知识。
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/11/15/苹果的文字系统/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/10/27/TheResponderChain/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/27/TheResponderChain/" itemprop="url">
                  iOS的事件处理顺序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-27T17:23:51+08:00">
                2016-10-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/iOS开发笔记/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          通常我们开发的app的UI元素都是有一个个view对堆叠起来的，也就是说我们点击屏幕的某一个区域的时候，会触动所有包含这个区域的view。那么这个触摸事件该由哪个View来处理，或者我们想更改iOS默认的处理方式又该如何下手，我们就需要先了解iOS中的事件是如何分发以及如何响应的。接下来介绍的是从官方文档精选出来的一部内容并加以了说明。
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/10/27/TheResponderChain/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/10/23/高效学习法/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/23/高效学习法/" itemprop="url">
                  高效学习法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-23T17:26:51+08:00">
                2016-10-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/方法论/" itemprop="url" rel="index">
                    <span itemprop="name">方法论</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="方法来源"><a href="#方法来源" class="headerlink" title="方法来源"></a>方法来源</h2><p>本文所介绍的学习方法主要的观点来自《如何阅读一本书》、《软技能：代码之外的生存指南》和《把时间当做朋友》。这三本书有些观点是极其相似的，本人将它们综合起来，并且结合了自身的一些体会，提炼出7大步骤。下面就开始介绍这套高效的学习方法。</p>
<h2 id="我要学什么"><a href="#我要学什么" class="headerlink" title="我要学什么"></a>我要学什么</h2><p>要学习的主题是什么，比如是摄影，还是iOS开发？</p>
<h2 id="筛选出我们想要学习的目标资源"><a href="#筛选出我们想要学习的目标资源" class="headerlink" title="筛选出我们想要学习的目标资源"></a>筛选出我们想要学习的目标资源</h2><p>互联网时代，我们要学习一项技能、一些概念更容易了，但是同时带来的困扰就是信息泛滥，我们需要甄别哪些知识是更真实的，更适合自己的。如果自己能力足够，阅读官方资料则是最好的学习资源。如果自己所具备的知识还不能比较轻松的学习官方资料，那么一些网络文章，或者书籍则是更为合适的学习资源。对于网络资源，来自比较权威的网站会比普通不知名的网站的资源更有说服力。对于书本，选择多人买、高评价的会更好，当自己无法做出选择的时候，到豆瓣看看这本书的分数也是个很不错的方法。</p>
<h2 id="制定明确的、具体的、无二义性的目标"><a href="#制定明确的、具体的、无二义性的目标" class="headerlink" title="制定明确的、具体的、无二义性的目标"></a>制定明确的、具体的、无二义性的目标</h2><p>请注意这个目标一定是要具体的，有多具体就有多具体，比如我说“我要学习iOS开发”，就没有“我要学会开发一款iOS音乐播放器”这么具体明确。之所以要制定一个明确的目标，主要有两个作用：</p>
<ul>
<li>目标是看得见的，不是模糊的，自己的思维会更清晰，更容易知道自己想做什么，怎么去做。</li>
<li>将自己学习的范围缩小了，这个目标就更容易实现，也更容易增加自身的积极性。</li>
</ul>
<h2 id="学习任何知识都要先从全局出发"><a href="#学习任何知识都要先从全局出发" class="headerlink" title="学习任何知识都要先从全局出发"></a>学习任何知识都要先从全局出发</h2><p>当我们刚买一台空调，我们可能先查阅说明书，说明书就是“全局”。当我们学习一份开源代码，我们可能回查看怎么结构是怎么样的，这个结构就是“全局”。对于一本书来说，目录就是这本书的“全局”，每一章书的开头通常来说也会是这个章节的“全局”。通过全局的把握知识，我们更加清楚的知道自己学习的进度如何，现在没懂的，接下来会不会在其他地方讲到。</p>
<h2 id="拆解成小任务"><a href="#拆解成小任务" class="headerlink" title="拆解成小任务"></a>拆解成小任务</h2><p>将一个学习计划拆分成一个个的小任务，这样更容易获得成就感，从而有利于提高自己的积极性。</p>
<h2 id="专注主线知识，不要被分支知识所诱惑"><a href="#专注主线知识，不要被分支知识所诱惑" class="headerlink" title="专注主线知识，不要被分支知识所诱惑"></a>专注主线知识，不要被分支知识所诱惑</h2><p>如同上网冲浪，本来打开C站的只是想看看新闻，结果有个商品的推荐广告吸引了自己，于是跳到了售卖该商品的网站，浏览过程中，又有其他类似商品的推荐，顶不住诱惑又跳到那个商品的页面，浏览了一小个小时，到头来就连今日新闻的标题是什么自己都不清楚。学习的过程中也会如此，途中可能会遇到一些我们不熟悉的概念或者其他的知识，我们这时候可能会本着“打破砂锅问到底”的”诚恳“的学习态度，上网搜索了这个概念的相关资料，没想到这个资料当中又有一些自己不甚了解的知识，反复如是，结果我们想要学习的主题一而再再而三的被拖延了，本来计划一个章节只花一周的学习时间，结果变成了两周或者更长，这多多少少都会打击到自己的积极性。所以我们应该在<strong>遇到不明白的知识点的时候，记录下来，回头单独找时间来学习它</strong>。</p>
<h2 id="不只是眼睛读，手还要动"><a href="#不只是眼睛读，手还要动" class="headerlink" title="不只是眼睛读，手还要动"></a>不只是眼睛读，手还要动</h2><p>我们学习的目的，相信最终都是想把知识深深的烙印在自己的脑海里。一切不能被自己吸收的知识的学习都是浪费时间。那如何才能做到呢？如果你过目不忘，那么不需要做其他的事情，只是看就行了。但是对于大多数人来说，都是普通人，我就是一个普通得不能再普通得人了，当下觉得记忆很清晰的事物，过一段时间或许就忘记了，所以我们最好是把我们当下学习到的知识以自己理解的方式记录下来。如果是读书，为了不打断思维的连贯性，通常我自己只是把重要的点记录画线标记下来，在我读完这章之后，再花时间把要点整理出来，记录到一个文档里面。如果是编程学习，那么在了解了整个知识架构之后，还需要按模块反复打磨细节，边学习理论，边敲代码。</p>
<h2 id="分享"><a href="#分享" class="headerlink" title="分享"></a>分享</h2><p>其实这个步骤应该是：传道授惑解惑。在这里对于我自己的现阶段而言，更愿意用”分享“这个词来替换”传道授惑“。因为分享往往意味着以平等甚至更低的姿态转述自己的知识，这样做有利于自己对对方观点的吸收。我还记得电影《一代宗师》里面出现的三个词汇：见自己、见天地、见众生。不知道你对这句话怎么理解的，我的理解就是：自我了解、不断学习、传道受业。学习的自然是可以解惑，那为什么教别人也是可以解惑呢？分享其实是个检验自己所学知识有多扎实的最好途径，因为要想把自己所知道的知识传递给他人，自己的的转述必须是脉络清晰的，这意味着自己能对知识做到真正的系统的了解。如果自己的转述不够清晰，听者这时候可能就会有所质疑，而这些质疑会促使我们再次整理我们的知识，循环渐进，我们的知识将更加牢固。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>这套学习方法，是我自己正在实践的方法，感觉效果不错，因此分享出来，希望能帮到一部分人，哪怕是一小部分。如果真是这样的话，我觉得这些写作的时间是十分值得的。我也希望自己在工作之余能更好更快的学习，最后能真的成为自己想要成为的人。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/10/22/从code7到xcode8都有哪些坑？/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/22/从code7到xcode8都有哪些坑？/" itemprop="url">
                  从code7到xcode8都有哪些坑?
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-22T10:08:17+08:00">
                2016-10-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/iOS开发笔记/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          自从有那段使用beta版本的Mac OSX系统，导致机器时常开机卡死的经历之后，就尽量不敢在第一时间使用苹果的beta版系统。但是，由于自己是名iOS开发者，当Xcode出了beta版本无疑是需要第一时间体验一下的，即使Xcode beta版本可以不体验，但是出了第一个Release版本却是不得不更新。接下来讲的就是在使用Xcode8.0所遇到的坑。
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/10/22/从code7到xcode8都有哪些坑？/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/09/16/Mach-O格式文件(用户态下的进程加载)/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/16/Mach-O格式文件(用户态下的进程加载)/" itemprop="url">
                  Mach-O格式文件(用户态下的进程加载)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-16T11:07:52+08:00">
                2016-09-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/深入解析Mac-OS-X-iOS操作系统笔记/" itemprop="url" rel="index">
                    <span itemprop="name">深入解析Mac OS X && iOS操作系统笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mach-O二进制文件"><a href="#Mach-O二进制文件" class="headerlink" title="Mach-O二进制文件"></a>Mach-O二进制文件</h2><p>Mach-O的文件头包含的内容:</p>
<ul>
<li>魔数</li>
<li>CPU类型及其子类型</li>
<li>文件类型</li>
<li>用于加载器的“加载命令”的条数和大小</li>
<li>动态链接器的标志</li>
</ul>
<blockquote>
<p>使用<code>otool -h /bin/ls</code>来查看Mach-O的文件头。</p>
</blockquote>
<h2 id="Mach-O的加载命令"><a href="#Mach-O的加载命令" class="headerlink" title="Mach-O的加载命令"></a>Mach-O的加载命令</h2><p>内核加载器会在加载的过程中使用这些命令来对进程进行一些设置：包括分配虚拟内存、创建主线程、启动动态链接器以及处理代码签名等工作。重要的命令有：</p>
<ul>
<li>LC_SEGMENT或者LC_SEGMENT_64（设置进程的内存空间）<ul>
<li>代码段（<strong>TEXT）、数据段(</strong>DATA)、用户动态链接的桩(<strong>stubs、</strong>stub_helper)、主程序代码(__text)</li>
</ul>
</li>
<li>LC_LOAD_DYLINKER(内核加载器在执行该命令时启动动态链接器)</li>
<li>LC_MAIN(设置进程的入口地址和栈大小，以及出程序计数器外的寄存器清零)</li>
<li>LC_CODE_SIGNATURE(代码签名)</li>
</ul>
<blockquote>
<p><code>otool</code>可以用来可以用来分析加载命令和代码段，如：<code>otool -l /bin/ls</code></p>
</blockquote>
<h2 id="动态库"><a href="#动态库" class="headerlink" title="动态库"></a>动态库</h2><h3 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h3><p>少量的进程只需要<code>内核加载器</code>就能完成加载，OSX中几乎所有的程序都是动态链接的–即填补对外部库和符号的引用。这个工作是由<code>动态链接器</code>来完成。该过程也被称为<code>符号绑定</code>。这个过程大概是这样的：</p>
<blockquote>
<p>如果二进制文件使用了外部定义的函数或符号，那么在他们的文本段中就会有一个名为__stubs的区，在这个区中存放的是本地未定义符号的占位符。编译器生成代码时会创建对符号桩的调用，链接器在运行的时候会解决对桩的这些调用–即在被调用的地址处放置一条JMP指令，并将控制权交给真实的函数体。但不会修改栈。因此真实的函数可以正常返回，就像直接调用函数一样。</p>
</blockquote>
<p>链接一般都是递归的，因为库也有可能引用其他的库。</p>
<h3 id="共享库缓存（shared-library-cache）"><a href="#共享库缓存（shared-library-cache）" class="headerlink" title="共享库缓存（shared library cache）"></a>共享库缓存（shared library cache）</h3><p>共享库缓存是dyld支持的的另一种机制。是指：一些库经过预先链接，然后保存在磁盘的一个文件中。</p>
<blockquote>
<p>在OS X中dyld共享缓存保存在<code>/private/var/db/dyld</code>目录下。在iOS中则保存在<code>/System/Library/Caches/com.apple.dyld</code>.</p>
</blockquote>
<h3 id="运行时加载"><a href="#运行时加载" class="headerlink" title="运行时加载"></a>运行时加载</h3><p>一般通过#include包含一些头文件，这种方式构建的可执行文件只有在解决了所有依赖条件之后才能加载执行。但是通过<code>&lt;dlfcn.h&gt;</code>头文件提供的函数就可以在运行时（runtime）加载库。这样函数有：</p>
<ul>
<li>dlopen(const char *path)</li>
<li>dlopen_preflight(const char *path)</li>
<li>dlsym(void <em>handle ,char </em>sym)</li>
<li>dladdr(char <em>addr , DL_Info </em>info)</li>
<li>dlerror()</li>
</ul>
<p>Cocoa和Carbon为dl*系列提供了高层的封装，以及CFBundle和NSBundle对象，用于加载Mach-O bundle文件。</p>
<h3 id="弱定义的符号"><a href="#弱定义的符号" class="headerlink" title="弱定义的符号"></a>弱定义的符号</h3><ul>
<li>通常情况下符号都是被声明为强定义的，即文件在执行之前必须先解析这些符号，若发生解析失败，则程序运行失败，通常也会触发调试器陷阱。</li>
<li>可以使用<code>__attribute__(weak_import)</code>将符号声明为弱符号。这样则在解析符号错误的时候，不会触发链接错误，动态链接器会将这个符号设置为NULL，效果跟运行时加载动态库类似（如dlopen）。</li>
</ul>
<blockquote>
<p>使用<code>nm -m xxx.dylib</code>可以显示弱符号。</p>
</blockquote>
<h2 id="dyld的特性"><a href="#dyld的特性" class="headerlink" title="dyld的特性"></a>dyld的特性</h2><h3 id="两级命名空间"><a href="#两级命名空间" class="headerlink" title="两级命名空间"></a>两级命名空间</h3><ul>
<li>通过将DYLD_FORCE_FLAT_NAMESPACE环境变量设置为非零即可禁用。</li>
<li>可执行文件也可以在文件头中设置MH_FORCE_FLAT标志，强制对其加载的所有库使用平坦命名空间。</li>
</ul>
<h3 id="函数拦截"><a href="#函数拦截" class="headerlink" title="函数拦截"></a>函数拦截</h3><ul>
<li><p>DYLD_INTERPOSE宏允许一个库将其函数替换为另一个函数。（跟iOS的swizzle类似）,例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DYLD_INTERPOSE(my_open ,open)</div></pre></td></tr></table></figure>
</li>
<li><p>dyld的函数拦截功能提供一个新的<strong>DATA区，名为</strong>interpose,在这个区中依次列出了替换的函数和被替换的函数，其他事情则交给dyld处理。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static const interpose_t interposing_functions[] \</div><div class="line">    __attribute__(section(&quot;__DATA,__interpose&quot;)) = &#123;</div><div class="line">        &#123;(void *)my_free , (void *)free &#125;,</div><div class="line">        &#123;(void *)my_malloc , (void *) malloc &#125;,</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>完整代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;malloc/malloc.h&gt; // for malloc_printf()</div><div class="line"></div><div class="line">// Note: Compile with GCC, not cc (important)</div><div class="line">//</div><div class="line">//</div><div class="line">// This is the expected interpose structure</div><div class="line"> typedef struct interpose_s &#123; void *new_func;</div><div class="line">			       void *orig_func; &#125; interpose_t;</div><div class="line">// Our prototypes - requires since we are putting them in </div><div class="line">//  the interposing_functions, below</div><div class="line"></div><div class="line">void *my_malloc(int size); // matches real malloc()</div><div class="line">void my_free (void *); // matches real free()</div><div class="line"></div><div class="line">// For clang, add attribute(used)</div><div class="line">static const interpose_t interposing_functions[] \ </div><div class="line">    __attribute__ ((used, section(&quot;__DATA, __interpose&quot;))) = &#123;</div><div class="line"></div><div class="line"> &#123; (void *)my_free, (void *)free &#125;,</div><div class="line"> &#123; (void *)my_malloc, (void *)malloc &#125; </div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line">void *</div><div class="line">my_malloc (int size) &#123;</div><div class="line"> // In our function we have access to the real malloc() -</div><div class="line"> // and since we don’t want to mess with the heap ourselves,</div><div class="line"> // just call it</div><div class="line"> //</div><div class="line">void *returned = malloc(size);</div><div class="line">// call malloc_printf() because the real printf() calls malloc()</div><div class="line">// // internally - and would end up calling us, recursing ad infinitum</div><div class="line"></div><div class="line">  malloc_printf ( &quot;+ %p %d\n&quot;, returned, size); return (returned);</div><div class="line">&#125;</div><div class="line">void</div><div class="line">my_free (void *freed) &#123;</div><div class="line">// Free - just print the address, then call the real free()</div><div class="line"></div><div class="line"></div><div class="line">  malloc_printf ( &quot;- %p\n&quot;, freed); free(freed);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#if 0</div><div class="line">  From output 4-11:</div><div class="line"></div><div class="line"> morpheus@Ergo(~)$ gcc -dynamiclib l.c -o libMTrace.dylib -Wall  // compile to dylib</div><div class="line"> morpheus@Ergo(~)$ DYLD_INSERT_LIBRARIES=libMTrace.dylib ls     // force insert into ls</div><div class="line"> ls(24346) malloc: + 0x100100020 88</div><div class="line"> ls(24346) malloc: + 0x100800000 4096</div><div class="line"> ls(24346) malloc: + 0x100801000 2160 </div><div class="line"> ls(24346) malloc: - 0x100800000 </div><div class="line"> ls(24346) malloc: + 0x100801a00 3312 ... // etc.</div><div class="line"></div><div class="line">#endif</div></pre></td></tr></table></figure></p>
<blockquote>
<p>使用<code>pagestuff</code>命令可以显示文件逻辑页中的符号。如：<code>pagestuff /usr/lib/libgmalloc.dylib 6</code>,</p>
</blockquote>
<h2 id="进程的地址空间"><a href="#进程的地址空间" class="headerlink" title="进程的地址空间"></a>进程的地址空间</h2><ul>
<li>每一个进程都有自己私有的虚拟地址空间。</li>
<li>32位地址空间，用户态可访问整个4G的内存空间。</li>
<li>64位的地址允许高达16EB（16GGB）</li>
<li>现代系统一般都会在每次启动进程的时候，将其地址空间随机化（随机的给每个段加上地址偏移）。<blockquote>
<p>使用<code>vmmap</code>命令来查看内存的空间布局，可以加上参数<code>-interleaved</code>以清晰的方式导出地址空间。</p>
</blockquote>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/09/11/Mach原语：一起以消息为媒介/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/11/Mach原语：一起以消息为媒介/" itemprop="url">
                  Mach原语：一切以消息为媒介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-11T17:05:13+08:00">
                2016-09-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/深入解析Mac-OS-X-iOS操作系统笔记/" itemprop="url" rel="index">
                    <span itemprop="name">深入解析Mac OS X && iOS操作系统笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Mach概述"><a href="#1-Mach概述" class="headerlink" title="1. Mach概述"></a>1. Mach概述</h2><h3 id="1-1-Mach设计原则"><a href="#1-1-Mach设计原则" class="headerlink" title="1.1 Mach设计原则"></a>1.1 Mach设计原则</h3><ul>
<li>在Mach中所有东西（Task、线程、虚拟内存等））都是对象。</li>
<li>对象与对象之间通信<strong>只能</strong>通过端口收发消息。</li>
</ul>
<h3 id="1-2-Mach设计目标"><a href="#1-2-Mach设计目标" class="headerlink" title="1.2 Mach设计目标"></a>1.2 Mach设计目标</h3><p>内核为了保持极简，只做如下的事情：</p>
<ul>
<li>“控制点”或执行单元的管理。</li>
<li>线程或线程组（Task）的资源分配。</li>
<li>虚拟内存的分配和管理。</li>
<li>底层物理资源–即CPU、内存和任何物理设备的分配。</li>
</ul>
<h2 id="2-Mach消息"><a href="#2-Mach消息" class="headerlink" title="2. Mach消息"></a>2. Mach消息</h2><h3 id="2-1-简单消息"><a href="#2-1-简单消息" class="headerlink" title="2.1 简单消息"></a>2.1 简单消息</h3><p>最基本的包含两部分：消息头、消息体。可以选择性的添加消息尾。结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">typedef	struct </div><div class="line">&#123;</div><div class="line">  mach_msg_bits_t	msgh_bits;//标志位</div><div class="line">  mach_msg_size_t	msgh_size;//大小</div><div class="line">  mach_port_t		msgh_remote_port;//目标端口（发送：接受方，接收：发送方）</div><div class="line">  mach_port_t		msgh_local_port; //源端口（发送：发送方，接收：接收方）</div><div class="line">  mach_port_name_t	msgh_voucher_port;</div><div class="line">  mach_msg_id_t		msgh_id;</div><div class="line">&#125; mach_msg_header_t; //消息头</div><div class="line"></div><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">        mach_msg_size_t msgh_descriptor_count;</div><div class="line">&#125; mach_msg_body_t;//消息体</div><div class="line"></div><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">        mach_msg_header_t       header;</div><div class="line">        mach_msg_body_t         body;</div><div class="line">&#125; mach_msg_base_t; //基本消息</div><div class="line"></div><div class="line">typedef	unsigned int mach_msg_trailer_type_t;//消息尾的类型</div><div class="line"></div><div class="line">typedef struct </div><div class="line">&#123;</div><div class="line">  mach_msg_trailer_type_t	msgh_trailer_type;</div><div class="line">  mach_msg_trailer_size_t	msgh_trailer_size;</div><div class="line">&#125; mach_msg_trailer_t; //消息尾</div></pre></td></tr></table></figure>
<h3 id="2-2-复杂消息"><a href="#2-2-复杂消息" class="headerlink" title="2.2 复杂消息"></a>2.2 复杂消息</h3><p>将消息头的标志位<code>mach_msg_bits_t</code>设置为<code>MACH_MSGH_BITS_COMPLEX</code>，就表示复杂消息。此时消息体里面指定了描述符的个数，接下来就是一个接着一个的描述符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">  uint64_t			address;//数据的大小</div><div class="line">  boolean_t     		deallocate: 8;//发送之后是否接触分配</div><div class="line">  mach_msg_copy_options_t       copy: 8;//复制指令</div><div class="line">  unsigned int     		pad1: 8;</div><div class="line">  mach_msg_descriptor_type_t    type: 8;</div><div class="line">  mach_msg_size_t       	size;//数据的大小</div><div class="line">&#125; mach_msg_ool_descriptor64_t;</div></pre></td></tr></table></figure>
<h3 id="2-3-消息收发"><a href="#2-3-消息收发" class="headerlink" title="2.3 消息收发"></a>2.3 消息收发</h3><p>消息的收发在用户态都是通过如下方法进行的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">extern mach_msg_return_t	mach_msg(</div><div class="line">					mach_msg_header_t *msg,</div><div class="line">					mach_msg_option_t option,//可以设置为收消息还是发消息等类型</div><div class="line">					mach_msg_size_t send_size,</div><div class="line">					mach_msg_size_t rcv_size,</div><div class="line">					mach_port_name_t rcv_name,</div><div class="line">					mach_msg_timeout_t timeout,</div><div class="line">					mach_port_name_t notify);</div></pre></td></tr></table></figure>
<h3 id="2-4-端口"><a href="#2-4-端口" class="headerlink" title="2.4 端口"></a>2.4 端口</h3><p>端口实际上就是一个整型的标识符，是如下结构（在osfmk/ipc/ipc_port.h中定义）的一个句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">struct ipc_port &#123;</div><div class="line"></div><div class="line">	/*</div><div class="line">	 * Initial sub-structure in common with ipc_pset</div><div class="line">	 * First element is an ipc_object second is a</div><div class="line">	 * message queue</div><div class="line">	 */</div><div class="line">	struct ipc_object ip_object;</div><div class="line">	struct ipc_mqueue ip_messages;</div><div class="line"></div><div class="line">	natural_t ip_sprequests:1,	/* send-possible requests outstanding */</div><div class="line">		  ip_spimportant:1,	/* ... at least one is importance donating */</div><div class="line">		  ip_impdonation:1,	/* port supports importance donation */</div><div class="line">		  ip_tempowner:1,	/* dont give donations to current receiver */</div><div class="line">		  ip_guarded:1,         /* port guarded (use context value as guard) */</div><div class="line">		  ip_strict_guard:1,	/* Strict guarding; Prevents user manipulation of context values directly */</div><div class="line">		  ip_reserved:2,</div><div class="line">		  ip_impcount:24;	/* number of importance donations in nested queue */</div><div class="line"></div><div class="line">	union &#123;</div><div class="line">		struct ipc_space *receiver;</div><div class="line">		struct ipc_port *destination;</div><div class="line">		ipc_port_timestamp_t timestamp;</div><div class="line">	&#125; data;</div><div class="line"></div><div class="line">	union &#123;</div><div class="line">		ipc_kobject_t kobject;</div><div class="line">		ipc_importance_task_t imp_task;</div><div class="line">		uintptr_t alias;</div><div class="line">	&#125; kdata;</div><div class="line">		</div><div class="line">	struct ipc_port *ip_nsrequest;</div><div class="line">	struct ipc_port *ip_pdrequest;</div><div class="line">	struct ipc_port_request *ip_requests;</div><div class="line">	struct ipc_kmsg *ip_premsg;</div><div class="line"></div><div class="line">	mach_vm_address_t ip_context;</div><div class="line"></div><div class="line">	mach_port_mscount_t ip_mscount;</div><div class="line">	mach_port_rights_t ip_srights;</div><div class="line">	mach_port_rights_t ip_sorights;</div><div class="line"></div><div class="line">#if	MACH_ASSERT</div><div class="line">#define	IP_NSPARES		4</div><div class="line">#define	IP_CALLSTACK_MAX	16</div><div class="line">/*	queue_chain_t	ip_port_links;*//* all allocated ports */</div><div class="line">	thread_t	ip_thread;	/* who made me?  thread context */</div><div class="line">	unsigned long	ip_timetrack;	/* give an idea of &quot;when&quot; created */</div><div class="line">	uintptr_t	ip_callstack[IP_CALLSTACK_MAX]; /* stack trace */</div><div class="line">	unsigned long	ip_spares[IP_NSPARES]; /* for debugging */</div><div class="line">#endif	/* MACH_ASSERT */</div><div class="line">&#125; __attribute__((__packed__));</div></pre></td></tr></table></figure>
<h3 id="2-5-Mach接口生成器（MIG）"><a href="#2-5-Mach接口生成器（MIG）" class="headerlink" title="2.5 Mach接口生成器（MIG）"></a>2.5 Mach接口生成器（MIG）</h3><p>Mach消息传递模型是远程调用（Remote Procedure Call，RPC）的一种现实(类似Thrift)。在/usr/include/mach目录下可以看到一些<code>.defs</code>文件，这些文件包含了Mach子系统（一组操作）的定义。操作类型如下：<br><img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/MIG_opt.png?raw=true" alt="IG_opt.png"></p>
<h2 id="3-深入IPC"><a href="#3-深入IPC" class="headerlink" title="3. 深入IPC"></a>3. 深入IPC</h2><ul>
<li>Mach的每个Task都包含一个指针，这个指针指向一个IPC命名空间，这个IPC命名空间了包含了Task的端口，当然Task还可以获取系统范围的端口，例如：主机端口、特权端口（可以重启机器等）等。</li>
<li>在用户态下，消息传递都是通过<code>mach_msg()</code>函数实现的，这个函数会触发一个mach陷阱<code>mach_msg_trap()</code>，接下来<code>mach_msg_trap()</code>又会调用<code>mach_msg_overwrite_trap()</code>，它会通过<code>MACH_SEND_MSG</code>和<code>MACH_RCV_MSG</code>来判断是发送操作，还是接收操作。</li>
<li>期中内核态中还可以通过<code>mach_msg_receive()</code>和<code>mach_msg_send()</code>来收发数据。</li>
</ul>
<h2 id="4-同步原语"><a href="#4-同步原语" class="headerlink" title="4. 同步原语"></a>4. 同步原语</h2><h3 id="4-1-锁的实现方式"><a href="#4-1-锁的实现方式" class="headerlink" title="4.1 锁的实现方式"></a>4.1 锁的实现方式</h3><ul>
<li><strong>阻塞</strong>：如果锁对象被其他线程所持有，那么请求访问的线程就会被加入到等待队列中，因而被阻塞。这就意味着被阻塞的线程放弃了时间片，调度器会将CPU让给下一个执行的的线程。<strong>当锁可用的时候</strong>，调度器会得到通知，然后根据情况将线程从等待队列取出来，并重新调度。</li>
<li><strong>忙等</strong>：线程不放弃CPU时间片，而是继续重复的尝试访问所对，直到锁可用。</li>
<li><strong>阻塞与忙等的对比</strong>：当锁只持续短短几个周期的时候，阻塞会带来性能问题，因为至少会消耗两次上下文切换的时间。因此如果锁的持续时间短，应该采用忙等形式的锁对象，反之就采用阻塞形式的锁对象。</li>
</ul>
<h3 id="4-2-互斥体-lck-mtx-t-（阻塞）"><a href="#4-2-互斥体-lck-mtx-t-（阻塞）" class="headerlink" title="4.2 互斥体(lck_mtx_t)（阻塞）"></a>4.2 互斥体(lck_mtx_t)（阻塞）</h3><ul>
<li>互斥体其实就是一个内核中的一个不同的变量，通常是机器字节大小的整数，但是必须要求硬件能对这些变量进行原子操作。</li>
<li>原子的意思就是：对互斥体的操作不能打断，即使是硬件中断也不能打断。</li>
</ul>
<h3 id="4-3-信号量-semaphore-t-（阻塞）"><a href="#4-3-信号量-semaphore-t-（阻塞）" class="headerlink" title="4.3 信号量(semaphore_t)（阻塞）"></a>4.3 信号量(semaphore_t)（阻塞）</h3><p>信号量在初始化的时候可以设置一个大于零的初始值。信号量包含两个操作：一个是+1操作，一个是-1操作，当值大于0表示锁可用，当值小于等于0的时候表示锁不可用。互斥体可以看做是初始值为1的信号量。</p>
<h3 id="4-4-自旋锁-hw-lock-t-（忙等）"><a href="#4-4-自旋锁-hw-lock-t-（忙等）" class="headerlink" title="4.4 自旋锁(hw_lock_t)（忙等）"></a>4.4 自旋锁(hw_lock_t)（忙等）</h3><p>一种采用忙等形式的锁。</p>
<h3 id="4-5-读写锁-hw-lock-t-（阻塞）"><a href="#4-5-读写锁-hw-lock-t-（阻塞）" class="headerlink" title="4.5 读写锁(hw_lock_t)（阻塞）"></a>4.5 读写锁(hw_lock_t)（阻塞）</h3><p>当多个线程对资源只做只读的操作，这种情况下这些线程并不会相互影响。为了提高效率，读写锁就应运而生了。读写锁能够区分是读访问还是写访问，对个读者可以同时持有锁，但一次只能一个写者持有锁。</p>
<h3 id="4-6-锁集-lock-set-t"><a href="#4-6-锁集-lock-set-t" class="headerlink" title="4.6 锁集(lock_set_t)"></a>4.6 锁集(lock_set_t)</h3><p>锁集就是锁的一个数组。</p>
<h2 id="5-机器原语"><a href="#5-机器原语" class="headerlink" title="5. 机器原语"></a>5. 机器原语</h2><h3 id="5-1-主机对象（Host）"><a href="#5-1-主机对象（Host）" class="headerlink" title="5.1 主机对象（Host）"></a>5.1 主机对象（Host）</h3><p>主机就是一组“特殊”端口的集合，以及一组异常处理程序的集合，同时定义了一个锁用于保护异常处理的并发访问。结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct	host &#123;</div><div class="line">	decl_lck_mtx_data(,lock)		/* lock to protect exceptions */</div><div class="line">	ipc_port_t special[HOST_MAX_SPECIAL_PORT + 1];</div><div class="line">	struct exception_action exc_actions[EXC_TYPES_COUNT];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="5-2-时钟对象（Clock）"><a href="#5-2-时钟对象（Clock）" class="headerlink" title="5.2 时钟对象（Clock）"></a>5.2 时钟对象（Clock）</h3><p>Mach内核提供了一个简单的“时钟”对象（在osfmk/kern/clock.h中定义）的抽象，这个对象用于计时和闹铃，期中最重要的内部API是<code>clock_deadline_for_periodic_event（）</code>，调度器通过它设置了一个重复发生的通知–从而保证了多任务引擎的运转。</p>
<h3 id="5-3-处理器对象（Processer）"><a href="#5-3-处理器对象（Processer）" class="headerlink" title="5.3 处理器对象（Processer）"></a>5.3 处理器对象（Processer）</h3><p>在多核架构中每一个核心都可以看做是一个CPU，处理器被分配给<strong>处理器集</strong>，处理器是CPU的简单抽象，被Mach用于一些基本的操作，比如：启动和关闭一个CPU，向CPU分发要执行的线程。结构的定义（在osfmk/kern/processor.h）如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">struct processor &#123;</div><div class="line">	queue_chain_t		processor_queue;/* idle/active queue link,</div><div class="line">										 * MUST remain the first element */</div><div class="line">	int					state;			/* See below */</div><div class="line">	boolean_t		is_SMT;</div><div class="line">	boolean_t		is_recommended;</div><div class="line">	struct thread</div><div class="line">						*active_thread,	/* thread running on processor */</div><div class="line">						*next_thread,	/* next thread when dispatched */</div><div class="line">						*idle_thread;	/* this processor&apos;s idle thread. */</div><div class="line"></div><div class="line">	processor_set_t		processor_set;	/* assigned set */</div><div class="line"></div><div class="line">	int					current_pri;	/* priority of current thread */</div><div class="line">	sched_mode_t		current_thmode;	/* sched mode of current thread */</div><div class="line">	sfi_class_id_t		current_sfi_class;	/* SFI class of current thread */</div><div class="line">	int					cpu_id;			/* platform numeric id */</div><div class="line"></div><div class="line">	timer_call_data_t	quantum_timer;	/* timer for quantum expiration */</div><div class="line">	uint64_t			quantum_end;	/* time when current quantum ends */</div><div class="line">	uint64_t			last_dispatch;	/* time of last dispatch */</div><div class="line"></div><div class="line">	uint64_t			deadline;		/* current deadline */</div><div class="line">	boolean_t               first_timeslice;                /* has the quantum expired since context switch */</div><div class="line"></div><div class="line">#if defined(CONFIG_SCHED_TRADITIONAL) || defined(CONFIG_SCHED_MULTIQ)</div><div class="line">	struct run_queue	runq;			/* runq for this processor */</div><div class="line">#endif</div><div class="line"></div><div class="line">#if defined(CONFIG_SCHED_TRADITIONAL)</div><div class="line">	int					runq_bound_count; /* # of threads bound to this processor */</div><div class="line">#endif</div><div class="line">#if defined(CONFIG_SCHED_GRRR)</div><div class="line">	struct grrr_run_queue	grrr_runq;      /* Group Ratio Round-Robin runq */</div><div class="line">#endif</div><div class="line"></div><div class="line">	processor_t			processor_primary;	/* pointer to primary processor for</div><div class="line">											 * secondary SMT processors, or a pointer</div><div class="line">											 * to ourselves for primaries or non-SMT */</div><div class="line">	processor_t		processor_secondary;</div><div class="line">	struct ipc_port *	processor_self;	/* port for operations */</div><div class="line"></div><div class="line">	processor_t			processor_list;	/* all existing processors */</div><div class="line">	processor_data_t	processor_data;	/* per-processor data */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中最重要的是runq，这是分发到这个处理器的线程队列。</p>
<h3 id="5-3-处理器集"><a href="#5-3-处理器集" class="headerlink" title="5.3 处理器集"></a>5.3 处理器集</h3><p>处理器集就是一个或多个processor_t的分组，也被称为pset。pset通常维护三个队列：</p>
<ul>
<li><code>active_queue</code>：用于保存当前正在执行线程的CPU。</li>
<li><code>idle_queue</code>：用于保存当前空闲的CPU（例如：正在执行<code>idle_thread</code>）。</li>
<li><code>pset_runq</code>：保存了在这个集合中的所有CPU上执行的线程。</li>
</ul>
<p><code>processor_set</code>的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">struct processor_set &#123;</div><div class="line">	queue_head_t		active_queue;	/* active processors */</div><div class="line">	queue_head_t		idle_queue;		/* idle processors */</div><div class="line">	queue_head_t		idle_secondary_queue;		/* idle secondary processors */</div><div class="line"></div><div class="line">	int					online_processor_count;</div><div class="line"></div><div class="line">	int					cpu_set_low, cpu_set_hi;</div><div class="line">	int					cpu_set_count;</div><div class="line"></div><div class="line">#if __SMP__</div><div class="line">	decl_simple_lock_data(,sched_lock)	/* lock for above */</div><div class="line">#endif</div><div class="line"></div><div class="line">#if defined(CONFIG_SCHED_TRADITIONAL) || defined(CONFIG_SCHED_MULTIQ)</div><div class="line">	struct run_queue	pset_runq;      /* runq for this processor set */</div><div class="line">#endif</div><div class="line"></div><div class="line">#if defined(CONFIG_SCHED_TRADITIONAL)</div><div class="line">	int					pset_runq_bound_count;</div><div class="line">		/* # of threads in runq bound to any processor in pset */</div><div class="line">#endif</div><div class="line"></div><div class="line">	/* CPUs that have been sent an unacknowledged remote AST for scheduling purposes */</div><div class="line">	uint64_t			pending_AST_cpu_mask;</div><div class="line">#if defined(CONFIG_SCHED_DEFERRED_AST)</div><div class="line">	/*</div><div class="line">	 * A seperate mask, for ASTs that we may be able to cancel.  This is dependent on</div><div class="line">	 * some level of support for requesting an AST on a processor, and then quashing</div><div class="line">	 * that request later.</div><div class="line">	 *</div><div class="line">	 * The purpose of this field (and the associated codepaths) is to infer when we</div><div class="line">	 * no longer need a processor that is DISPATCHING to come up, and to prevent it</div><div class="line">	 * from coming out of IDLE if possible.  This should serve to decrease the number</div><div class="line">	 * of spurious ASTs in the system, and let processors spend longer periods in</div><div class="line">	 * IDLE.</div><div class="line">	 */</div><div class="line">	uint64_t			pending_deferred_AST_cpu_mask;</div><div class="line">#endif</div><div class="line"></div><div class="line">	struct ipc_port	*	pset_self;		/* port for operations */</div><div class="line">	struct ipc_port *	pset_name_self;	/* port for information */</div><div class="line"></div><div class="line">	processor_set_t		pset_list;		/* chain of associated psets */</div><div class="line">	pset_node_t			node;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/09/08/Building xnu for OS X 10.11 El Capitan/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/08/Building xnu for OS X 10.11 El Capitan/" itemprop="url">
                  Building xnu for OS X 10.11 El Capitan
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-08T10:36:41+08:00">
                2016-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/深入解析Mac-OS-X-iOS操作系统笔记/" itemprop="url" rel="index">
                    <span itemprop="name">深入解析Mac OS X && iOS操作系统笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>此文只因为国内浏览<a href="http://shantonu.blogspot.co.uk" target="_blank" rel="external">ssen’s blog</a>需要翻墙，为了方便浏览从中拷贝了一份。</em></p>
<p>The OS X kernel source (xnu) has been released for OS X 10.11 El Capitan: <a href="https://opensource.apple.com/source/xnu/xnu-3247.1.106/" target="_blank" rel="external">here</a></p>
<p>Building xnu requires Xcode and some additional open-source (but not pre-installed) dependencies. You can build xnu manually by doing:</p>
<ol>
<li>Install OS X El Capitan and Xcode 7.0, 7.1, or 7.2 from the Mac App Store, make sure the Xcode license has been agreed-to with “sudo xcodebuild -license”</li>
<li><p>Download the source for the dtrace and AvailabilityVersions projects, which are required dependencies, as well as xnu itself</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ curl -O https://opensource.apple.com/tarballs/dtrace/dtrace-168.tar.gz</div><div class="line">$ curl -O https://opensource.apple.com/tarballs/AvailabilityVersions/AvailabilityVersions-20.tar.gz</div><div class="line">$ curl -O https://opensource.apple.com/tarballs/xnu/xnu-3247.1.106.tar.gz</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>Build and install CTF tools from dtrace</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    $ tar zxf dtrace-168.tar.gz</div><div class="line">    $ cd dtrace-168</div><div class="line">    $ mkdir -p obj sym dst</div><div class="line">    $ xcodebuild install -target ctfconvert -target ctfdump -target ctfmerge ARCHS=&quot;x86_64&quot; SRCROOT=$PWD OBJROOT=$PWD/obj SYMROOT=$PWD/sym DSTROOT=$PWD/dst</div><div class="line">    ...</div><div class="line">    $ sudo ditto $PWD/dst/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain</div><div class="line">    Password:</div><div class="line">    $ cd ..</div><div class="line">	```    </div><div class="line"></div><div class="line">4. Install AvailabilityVersions</div></pre></td></tr></table></figure>
<p> $ tar zxf AvailabilityVersions-20.tar.gz<br> $ cd AvailabilityVersions-20<br> $ mkdir -p dst<br> $ make install SRCROOT=$PWD DSTROOT=$PWD/dst<br> $ sudo ditto $PWD/dst/usr/local <code>xcrun -sdk macosx -show-sdk-path</code>/usr/local<br> $ cd ..</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">5. Build xnu</div></pre></td></tr></table></figure>
<p> $ tar zxf xnu-3247.1.106.tar.gz<br> $ cd xnu-3247.1.106<br> $ make SDKROOT=macosx ARCH_CONFIGS=X86_64 KERNEL_CONFIGS=RELEASE</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">**See xnu&apos;s top-level README for additional build variables that can be passed on the command-line, such as BUILD\_LTO=0 or KERNEL\_CONFIGS=DEVELOPMENT .**</div><div class="line"></div><div class="line">Update: If you are attempting to add system calls, you may also need to build Libsyscall.</div><div class="line"></div><div class="line">1. Download the Libsystem source</div></pre></td></tr></table></figure>
<p> $ curl -O <a href="https://opensource.apple.com/tarballs/Libsystem/Libsystem-1225.1.1.tar.gz" target="_blank" rel="external">https://opensource.apple.com/tarballs/Libsystem/Libsystem-1225.1.1.tar.gz</a></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2. Install Libsystem headers</div></pre></td></tr></table></figure>
<p> $ tar zxf Libsystem-1225.1.1.tar.gz<br> $ cd Libsystem-1225.1.1<br> $ xcodebuild installhdrs -sdk macosx ARCHS=’x86_64 i386’ SRCROOT=$PWD OBJROOT=$PWD/obj SYMROOT=$PWD/sym DSTROOT=$PWD/dst<br> $ sudo ditto $PWD/dst <code>xcrun -sdk macosx -show-sdk-path</code><br> $ cd ..</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">3. Install xnu and Libsyscall headers</div></pre></td></tr></table></figure>
<p> $ cd xnu-3247.1.106<br> $ mkdir -p BUILD.hdrs/obj BUILD.hdrs/sym BUILD.hdrs/dst<br> $ make installhdrs SDKROOT=macosx ARCH_CONFIGS=X86_64 SRCROOT=$PWD OBJROOT=$PWD/BUILD.hdrs/obj SYMROOT=$PWD/BUILD.hdrs/sym DSTROOT=$PWD/BUILD.hdrs/dst<br> $ sudo xcodebuild installhdrs -project libsyscall/Libsyscall.xcodeproj -sdk macosx ARCHS=’x86_64 i386’ SRCROOT=$PWD/libsyscall OBJROOT=$PWD/BUILD.hdrs/obj SYMROOT=$PWD/BUILD.hdrs/sym DSTROOT=$PWD/BUILD.hdrs/dst<br> $ sudo ditto BUILD.hdrs/dst <code>xcrun -sdk macosx -show-sdk-path</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">4. Build Libsyscall</div></pre></td></tr></table></figure>
<p> $ mkdir -p BUILD.libsyscall/obj BUILD.libsyscall/sym BUILD.libsyscall/dst<br> $ sudo xcodebuild install -project libsyscall/Libsyscall.xcodeproj -sdk macosx ARCHS=’x86_64 i386’ SRCROOT=$PWD/libsyscall OBJROOT=$PWD/BUILD.libsyscall/obj SYMROOT=$PWD/BUILD.libsyscall/sym DSTROOT=$PWD/BUILD.libsyscall/dst</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">5. To install custom OS components, [System Integrity Protection must be disabled](https://developer.apple.com/library/mac/documentation/Security/Conceptual/System_Integrity_Protection_Guide/ConfiguringSystemIntegrityProtection/ConfiguringSystemIntegrityProtection.html#//apple_ref/doc/uid/TP40016462-CH5-SW1).</div><div class="line"></div><div class="line">6. To install the resulting new binaries, execute:</div><div class="line">  	1. xnu:</div></pre></td></tr></table></figure>
<pre><code>$ sudo cp BUILD/obj/RELEASE_X86_64/kernel /System/Library/Kernels/
$ sudo kextcache -invalidate /
/ locked; waiting for lock.
Lock acquired; proceeding.
...
$ sudo reboot
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2. Libsyscall:</div></pre></td></tr></table></figure>

$ sudo cp BUILD.libsyscall/dst/usr/lib/system/libsystem_kernel.dylib /usr/lib/system/
$ sudo update_dyld_shared_cache
...
$ sudo reboot
```
</code></pre></li>
</ol>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/09/07/由生到死--内核引导和内核崩溃/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/07/由生到死--内核引导和内核崩溃/" itemprop="url">
                  由生到死--内核引导和内核崩溃
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-07T20:43:53+08:00">
                2016-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/深入解析Mac-OS-X-iOS操作系统笔记/" itemprop="url" rel="index">
                    <span itemprop="name">深入解析Mac OS X && iOS操作系统笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="XNU内核的编译"><a href="#XNU内核的编译" class="headerlink" title="XNU内核的编译"></a>XNU内核的编译</h2><p>参考<a href="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20%26%20iOS操作系统/Building%20xnu%20for%20OS%20X%2010.11%20El%20Capitan.md">Building xnu for OS X 10.11 El Capitan</a>,但是还没有成功编译通过。。。</p>
<h2 id="一个内核，支持多种架构"><a href="#一个内核，支持多种架构" class="headerlink" title="一个内核，支持多种架构"></a>一个内核，支持多种架构</h2><ul>
<li>osfmk目录包含了架构相关的子目录（如：i386，x86_64）。</li>
<li>pexpert目录（即，Platform Expert的目录）,规模不大，但很重要，包含了每个架构的个性化函数。</li>
<li>i386的Platform Expert与EFI紧密结合，而ARM的Platform Expert则跟iBoot紧密结合。pexpert目录的结构如下表：<br><img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/platformExpert.png?raw=true" alt="pexpert结构"></li>
</ul>
<h2 id="内核代码树"><a href="#内核代码树" class="headerlink" title="内核代码树"></a>内核代码树</h2><ul>
<li>可以使用<a href="http://fxr.watson.org" target="_blank" rel="external">FXR浏览工具</a>查看源码。</li>
<li><p>XNU主目录结构：<br>  <img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/XNU_SubDirectory.png?raw=true" alt="XNU主目录结构"></p>
</li>
<li><p>BSD目录结构：<br>  <img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/BSD_SubDirectory.png?raw=true" alt="BSD目录结构"></p>
</li>
<li><p>OSFMK目录结构：<br>  <img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/OSFMK_Subdirectory.png?raw=true" alt="OSFMK目录结构">    </p>
</li>
</ul>
<h2 id="XNU的引导过程"><a href="#XNU的引导过程" class="headerlink" title="XNU的引导过程"></a>XNU的引导过程</h2><p><strong>XNU是一个Mach-O二进制文件，引导加载器（EFI或iBoot）中包含了解析Mach-O文件的代码，可以通过LC_UNIXTHREAD命令计算出入口点。</strong></p>
<h3 id="从高层次看XNU的引导过程"><a href="#从高层次看XNU的引导过程" class="headerlink" title="从高层次看XNU的引导过程"></a>从高层次看XNU的引导过程</h3><ul>
<li>整个过程如下图，后面会介绍各个阶段的细节。<br>  <img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/XNU_hightLevel_boot.png?raw=true" alt="高层次看XNU的引导过程"></li>
<li><p><strong>OSX：vstart</strong></p>
<ul>
<li>如果是Debug环境初始化串口（pal_serial_init()）。</li>
<li>开启NX/XD：防止代码注入。</li>
<li>初始化主CPU的<a href="http://blog.csdn.net/yleek/article/details/8204393" target="_blank" rel="external">GDT和LDT</a>，然后调用cpu_desc_load(64）加载主CPU和从属CPU的LDT。（cpu_desc_init[64] (osfmk/i386/mp_desc.c)）</li>
<li>初始化所有CPU的MSR（用户SYSENTER和SYSCALL）以及物理内存映射。（cpu_mode_init()）</li>
<li>主从CPU调用相应的i386_init/i386_init_slave。</li>
</ul>
</li>
<li><p><strong>iOS：start</strong></p>
<p>  这个函数主要的工作就是：通过设置ARM控制寄存器，安装ExceptionVectorsBase内核陷阱处理程序，以及其他的一些设置，然后跳转到arm_init。</p>
</li>
<li><p><strong>[i386|arm]_init</strong>（osfmk/i386/i386_init.c）</p>
<p>  <em>主要工作是初始化主CPU为可用状态，然后准备好内核引导。</em></p>
</li>
<li><p><strong>i386_init_slave()</strong><br>初始化从CPU。</p>
</li>
<li><p><strong>machine_startup</strong></p>
</li>
</ul>
<p>主要负责解析一些命令行参数（通过Platform Expert提供的PE_parse_boot_argn函数），这些参数大部分是用来调试的boot-arg，用于控制引导时的调试。</p>
<ul>
<li><strong>kernel_bootstrap</strong><br>这个函数继续初始化Mach内核的的各个子系统，建立起BSD所依赖的必要基础设施。主要工作有：<ul>
<li><strong>初始化虚拟内存</strong>。</li>
<li><strong>IPC（进程间通信）</strong>：是Mach构建的根基，IPC要求一些重要的资源，例如：内存、同步对象、Mach接口成成器（MIG）。</li>
<li><strong>时钟</strong>：通过时钟实现闹铃、报时功能。 </li>
<li><strong>账本</strong>：Mach系统的记账功能。</li>
<li><strong>任务</strong>：任务是Mach的容器，类似BSD的进程（Mach的任务和BSD的进程是1:1对应的）。</li>
<li><strong>线程</strong>：线程是实际执行的单元，任务只不过是资源的容器，真正被调度和执行的是线程。<br>其中调用的重要的函数有：</li>
<li>kernel_bootstrap_thread:他的工作如下<ol>
<li>主线程开始以<code>kernel_bootstrap_thread</code>的身份运行，初始化各个子系统。</li>
<li>调用kernel_create_thread()派生辅助线程。第一个创建的线程是<strong>idle线程</strong>（这个线程是必要的，因为在所有线程都阻塞时，CPU总要有一个线程可以执行）。</li>
<li>下-个创建线程就是<strong>线程调度器</strong>，其任务是：在特定的时间间隔以及发生中断之后判定下一个要执行的线程是什么。</li>
<li>OSX的XNU启动<code>mapping_replenish线程</code>，在iOS上是<code>zone_refill_thread线程</code>。</li>
<li>如果内核设置了<strong>SERIAL_KDP</strong>,那么调度器会调用<code>init_kdp()</code>初始化调试器。</li>
<li>初始化<strong>IOKit</strong>，如果没有<strong>IOKit</strong>，XNU将无法访问硬件设备。</li>
<li>启用<strong>中断</strong>。</li>
<li>初始化<strong>共享区模块（shared region）</strong>，dyld在加载共享库时会使用这个模块，内核本身的<strong>commpage</strong>也会使用这个模块，<strong>commpage</strong>指的是一个从内核直接映射到所有进程的页面，包含一些导出数据和一些函数，这个页面总是驻留在同一个地址，并且所有进程都可以访问。</li>
<li>如果编译时启动了<strong>MAC（Mandatory Access Control）</strong>，则会调用<code>mac_policy_initmach()</code>。</li>
<li>调用<code>bsd_init</code>初始化BSD子系统，这个函数最终会派生出init任务来执行<code>bin/launchd</code>，init任务是所有用户态进程的祖先。</li>
<li>如果内核启动时传入了serial参数，那么会创建一个专用的控制台监听线程，用来启动控制台。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="睡眠和唤醒"><a href="#睡眠和唤醒" class="headerlink" title="睡眠和唤醒"></a>睡眠和唤醒</h2><p>睡眠流程一般如下：</p>
<ul>
<li>除了当前CPU外，停止其他的CPU。</li>
<li>关闭本地的APIC，准备进入睡眠。</li>
<li>输出一条kdebug消息。</li>
<li>在x86_64平台上保留CR3。</li>
<li>调用<code>acpi_sleep_cpu()</code>,将CPU设置为睡眠状态。</li>
<li>将控制权交给固件。</li>
</ul>
<p>唤醒处理程序的工作是：</p>
<ul>
<li>切换回64位模式。</li>
<li>恢复内核的GDT、CR0、LDT、IDT以及任务寄存器。</li>
<li>恢复所有保存的寄存器。</li>
</ul>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/09/04/内核架构/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/04/内核架构/" itemprop="url">
                  内核架构
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-04T22:42:35+08:00">
                2016-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/深入解析Mac-OS-X-iOS操作系统笔记/" itemprop="url" rel="index">
                    <span itemprop="name">深入解析Mac OS X && iOS操作系统笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          内核架构的分类，其实是按照内核态、内核所在的内存空间和用户态进程的内存空间之间的共享程度来区分的...
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/09/04/内核架构/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://github.com/Easence/2016/09/02/贯穿始终-launchd/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EA88">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EA88'Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EA88'Blog" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/02/贯穿始终-launchd/" itemprop="url">
                  贯穿始终-launchd
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-02T21:22:44+08:00">
                2016-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Development</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Development/深入解析Mac-OS-X-iOS操作系统笔记/" itemprop="url" rel="index">
                    <span itemprop="name">深入解析Mac OS X && iOS操作系统笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="launchd"><a href="#launchd" class="headerlink" title="launchd"></a>launchd</h2><p>launchd（PID 1）有内核直接启动，是用户态的第一个进程，其他进程都是由它直接或者间接的启动的。其他的launchd（比如其他用户远程登录后会对应创建一个launchd）都是由launchd（PID 1）启动的。<br>launchd分为两种类型的后台作业：</p>
<ul>
<li><strong>守护程序</strong>（daemon），不可和用户交互。</li>
<li><strong>代理程序</strong>（agent），特殊的守护程序，可以和用户交互。</li>
</ul>
<h2 id="launchd的职责"><a href="#launchd的职责" class="headerlink" title="launchd的职责"></a>launchd的职责</h2><h3 id="运行定时作业"><a href="#运行定时作业" class="headerlink" title="运行定时作业"></a>运行定时作业</h3><p>指定时间运行指定的命令。</p>
<h3 id="启动网络服务"><a href="#启动网络服务" class="headerlink" title="启动网络服务"></a>启动网络服务</h3><p>绑定一些端口（UDP端口或TCP端口），当网络请求到达的时候，根据需要启动相应的服务程序，并将服务程序的输入输出描述符（stdin、stderr和stdout）连接到对应的套接字。这样可以降低系统的负载。</p>
<h3 id="提供自举服务"><a href="#提供自举服务" class="headerlink" title="提供自举服务"></a>提供自举服务<servers bootstrap.h=""></servers></h3><ul>
<li>launchd在启动的时候声明一个端口（<strong>bootstrap_port</strong>）,由于所有进程都是launchd的后代，所以所有进程都可以通过这个<strong>bootstrap_port</strong>来访问自举服务器来查询某个服务，并且匹配服务程序的端口。</li>
<li>如果想要在自举服务器中注册自己端口的服务程序也可以通过<servers bootstrap.h="">中定义的函数<code>bootstrap_check_in()</code>来实现。还可以通过服务程序自己的plist文件来向launcchd注册（可以想象一下Android的Serverice）。</servers></li>
</ul>
<h3 id="事物支持"><a href="#事物支持" class="headerlink" title="事物支持"></a>事物支持</h3><p><code>vproc_transaction_begi</code>n和<code>vproc_transaction_end</code>之间的操作称为<strong>未决事物</strong>，当一个launchd有未决事物的时候会在系统关闭、用户退出，或超时被优雅的杀掉，否则强制杀掉。</p>
<h3 id="资源限制和遏制"><a href="#资源限制和遏制" class="headerlink" title="资源限制和遏制"></a>资源限制和遏制</h3><p>iOS Jetsam机制，可以强制施行虚拟内存使用率限制。</p>
<h3 id="Autorun模拟和文件系统观察"><a href="#Autorun模拟和文件系统观察" class="headerlink" title="Autorun模拟和文件系统观察"></a>Autorun模拟和文件系统观察</h3><ul>
<li>launchd提供了startOnMount键，当一个文件系统挂载的时候会自动触发一个守护进程。</li>
<li>通过WatchPaths或QueueDirectories键，launchd还可以设置一个观察路径，不一定要求是挂载点。</li>
</ul>
<h3 id="整合了I-O-Kit"><a href="#整合了I-O-Kit" class="headerlink" title="整合了I/O Kit"></a>整合了I/O Kit</h3><h2 id="iOS的launchDeamon"><a href="#iOS的launchDeamon" class="headerlink" title="iOS的launchDeamon"></a>iOS的launchDeamon</h2><p>iOS包含的launchDeamon列表如下图所示：<br><img src="https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&amp;%20iOS操作系统/Resources/Images/iOSLaunchDeamon.png?raw=true" alt="launchDeamon"></p>
<p><strong>其中最重要的两个守护进程是lockdownd和SpringBoard</strong></p>
<h3 id="lockdownd"><a href="#lockdownd" class="headerlink" title="lockdownd"></a>lockdownd</h3><p>lockdownd有launchd启动，它负责处理设备激活、备份、崩溃报告、设备同步以及其他的服务。</p>
<h3 id="SpringBoard"><a href="#SpringBoard" class="headerlink" title="SpringBoard"></a>SpringBoard</h3><ul>
<li>创建GUI</li>
<li>处理UI，如果SpringBoard停止了所有UI事件都无法到达相应的应用，只有SpingBoard恢复执行的时候，才会将所有排队的UI事件投递到应用程序。</li>
<li>SpringBoard包含大量的线程，比如：<ul>
<li>有Web相关的线程（WebCore和WebThread）</li>
<li>WiFiManager</li>
<li>CoreAnimation</li>
</ul>
</li>
<li>SpringBoard通过launchd注册了很多Mach端口，其中最重要的是<code>PurpleSystemEventPort</code>，这个端口通过GSEvent消息的方式处理UI事件。SPringBoard的主线程调用GSEventRun(),GSEventRun()是一个处理UI消息的CFRunloop。</li>
</ul>
<h2 id="XPC"><a href="#XPC" class="headerlink" title="XPC"></a>XPC</h2><ul>
<li>XPC是Lion和iOS5以后引入的轻量级的进程间通信原语。XPC和GCD紧密结合在一起。XPC依赖两个私有的框架：XPCService和XPCObjects。前者负责处理XPC服务运行时相关的事务，后者为XPC对象提供编码和解码服务。iOS还包含一个私有框架：XPCKit。常用函数有：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xpc_connection_send_message</div><div class="line">(xpc_connection_t connection, xpc_object_t message); //Send message asynchronously on connection.</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xpc_connection_send_barrier</div><div class="line">(xpc_connection_t connection, dispatch_block_t barrier); //Execute barrier block after last message is sent on connection.</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xpc_connection_send_message_with_reply</div><div class="line">(xpc_connection_t connection, xpc_object_t message, dispatch_queue_t replyq, xpc_handler_t handler); //Send message, but also asynchronously execute handler in dispatch queue replyq when a reply is received.</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">xpc_object_t</div><div class="line">xpc_connection_send_message_with_reply_sync</div><div class="line">(xpc_connection_t connection, xpc_object_t message); //Send message, blocking until a reply is received, and return reply as the xpc_ object_t return value</div></pre></td></tr></table></figure>
<ul>
<li>XPC的例子可以参照：苹果官方的<a href="https://developer.apple.com/library/mac/samplecode/SandboxedFetch/Introduction/Intro.html#//apple_ref/doc/uid/DTS40011117-Intro-DontLinkElementID_2" target="_blank" rel="external">SandboxedFetch</a></li>
</ul>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="EA88" />
          <p class="site-author-name" itemprop="name">EA88</p>
          <p class="site-description motion-element" itemprop="description">见自己、见天地、见众生</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">25</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Easence" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/EA_Huang" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">EA88</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
